generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String                  @id @default(cuid())
  name                  String?
  email                 String                  @unique
  emailVerified         DateTime?
  image                 String?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  accounts              Account[]
  conversations         ChatConversation[]
  sessions              Session[]
  travelExtractionQueue TravelExtractionQueue[]
  trips                 Trip[]
  contacts              UserContact[]
  hobbies               UserHobby[]
  profile               UserProfile?
  profileGraph          UserProfileGraph?
  profileValues         UserProfileValue[]
  relatedTo             UserRelationship[]      @relation("RelatedToUser")
  relationships         UserRelationship[]      @relation("UserRelationships")
  travelPreferences     UserTravelPreference[]
}

model Account {
  id                 Int       @id @default(autoincrement())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  canLogin           Boolean   @default(true)
  isPrimaryLogin     Boolean   @default(false)
  lastLoginAt        DateTime?
  syncStatus         String    @default("active")
  oauth_profile_data Json?
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId, canLogin])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  id           String   @id @default(cuid())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model Trip {
  id            String             @id @default(cuid())
  title         String
  description   String
  imageUrl      String?
  startDate     DateTime
  endDate       DateTime
  userId        String
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  imageIsCustom Boolean            @default(false)
  imagePromptId String?
  permissions   TripPermission     @default(PRIVATE)
  status        TripStatus         @default(DRAFT)
  conversations ChatConversation[]
  segments      Segment[]
  imagePrompt   ImagePrompt?       @relation(fields: [imagePromptId], references: [id])
  user          User               @relation(fields: [userId], references: [id])
}

model Segment {
  id                String             @id @default(cuid())
  startTitle        String
  startLat          Float
  startLng          Float
  endTitle          String
  endLat            Float
  endLng            Float
  notes             String?
  startTime         DateTime?
  endTime           DateTime?
  tripId            String
  order             Int                @default(0)
  createdAt         DateTime           @default(now())
  imageUrl          String?
  name              String
  segmentTypeId     String
  imageIsCustom     Boolean            @default(false)
  endTimeZoneId     String?
  endTimeZoneName   String?
  startTimeZoneId   String?
  startTimeZoneName String?
  conversations     ChatConversation[]
  reservations      Reservation[]
  segmentType       SegmentType        @relation(fields: [segmentTypeId], references: [id])
  trip              Trip               @relation(fields: [tripId], references: [id], onDelete: Cascade)
}

model SegmentType {
  id          String    @id @default(cuid())
  name        String    @unique
  createdAt   DateTime  @default(now())
  description String?
  segments    Segment[]
}

model ReservationCategory {
  id        String            @id @default(cuid())
  name      String            @unique
  createdAt DateTime          @default(now())
  types     ReservationType[]
}

model ReservationType {
  id           String              @id @default(cuid())
  name         String
  categoryId   String
  createdAt    DateTime            @default(now())
  reservations Reservation[]
  category     ReservationCategory @relation(fields: [categoryId], references: [id])

  @@unique([categoryId, name])
}

model ReservationStatus {
  id           String        @id @default(cuid())
  name         String        @unique
  createdAt    DateTime      @default(now())
  reservations Reservation[]
}

model Reservation {
  id                  String             @id @default(cuid())
  name                String
  confirmationNumber  String?
  notes               String?
  reservationTypeId   String
  reservationStatusId String
  segmentId           String
  startTime           DateTime?
  endTime             DateTime?
  cost                Float?
  currency            String?
  location            String?
  url                 String?
  imageUrl            String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  arrivalLocation     String?
  arrivalTimezone     String?
  departureLocation   String?
  departureTimezone   String?
  imageIsCustom       Boolean            @default(false)
  cancellationPolicy  String?
  contactEmail        String?
  contactPhone        String?
  latitude            Float?
  longitude           Float?
  timeZoneId          String?
  timeZoneName        String?
  vendor              String?
  conversations       ChatConversation[]
  reservationStatus   ReservationStatus  @relation(fields: [reservationStatusId], references: [id])
  reservationType     ReservationType    @relation(fields: [reservationTypeId], references: [id])
  segment             Segment            @relation(fields: [segmentId], references: [id], onDelete: Cascade)
}

model ChatConversation {
  id            String        @id @default(cuid())
  userId        String
  title         String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  tripId        String?
  chatType      ChatType      @default(TRIP)
  reservationId String?
  segmentId     String?
  reservation   Reservation?  @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  segment       Segment?      @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  trip          Trip?         @relation(fields: [tripId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages      ChatMessage[]
}

model ChatMessage {
  id             String           @id @default(cuid())
  conversationId String
  role           String
  content        String
  toolCalls      Json?
  createdAt      DateTime         @default(now())
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model ImagePromptStyle {
  id          String        @id @default(cuid())
  name        String        @unique
  slug        String        @unique
  description String?
  isDefault   Boolean       @default(false)
  isActive    Boolean       @default(true)
  sortOrder   Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  prompts     ImagePrompt[]

  @@index([isDefault])
  @@index([isActive, sortOrder])
}

model ImagePrompt {
  id        String            @id @default(cuid())
  name      String            @unique
  prompt    String            @db.Text
  category  String
  lightness String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  styleId   String?
  style     ImagePromptStyle? @relation(fields: [styleId], references: [id])
  trips     Trip[]
  isActive  Boolean           @default(true)
  sortOrder Int               @default(0)

  @@unique([styleId, category])
  @@index([styleId, category])
  @@index([isActive])
}

model ImageQueue {
  id         String   @id @default(cuid())
  entityType String
  entityId   String
  prompt     String
  status     String   @default("waiting")
  notes      String?
  imageUrl   String?
  attempts   Int      @default(0)
  promptId   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  logId      String?

  @@index([status, createdAt])
  @@index([entityType, entityId])
}

model ImageGenerationLog {
  id               String   @id @default(cuid())
  entityType       String
  entityId         String
  entityName       String?
  promptId         String?
  promptName       String?
  promptStyle      String?
  fullPrompt       String
  aiReasoning      String?
  selectionReason  String?
  availablePrompts String?
  callerFunction   String?
  callerSource     String?
  userId           String?
  status           String
  imageUrl         String?
  errorMessage     String?
  generationTimeMs Int?
  imageProvider    String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([entityType, entityId])
  @@index([promptId])
  @@index([status])
  @@index([createdAt])
}

model UserProfile {
  id                String    @id @default(cuid())
  userId            String    @unique
  dateOfBirth       DateTime?
  address           String?
  city              String?
  country           String?
  loyaltyPrograms   Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  firstName         String?
  lastName          String?
  homeAirports      Json?
  preferredAirports Json?
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ContactType {
  id        String        @id @default(cuid())
  name      String        @unique
  label     String
  icon      String?
  isActive  Boolean       @default(true)
  sortOrder Int           @default(0)
  createdAt DateTime      @default(now())
  contacts  UserContact[]
}

model UserContact {
  id            String      @id @default(cuid())
  userId        String
  contactTypeId String
  value         String
  label         String?
  isPrimary     Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  contactType   ContactType @relation(fields: [contactTypeId], references: [id])
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, contactTypeId])
}

model Hobby {
  id        String      @id @default(cuid())
  name      String      @unique
  category  String?
  icon      String?
  isActive  Boolean     @default(true)
  sortOrder Int         @default(0)
  createdAt DateTime    @default(now())
  users     UserHobby[]
}

model UserHobby {
  id        String   @id @default(cuid())
  userId    String
  hobbyId   String
  level     String?
  createdAt DateTime @default(now())
  hobby     Hobby    @relation(fields: [hobbyId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, hobbyId])
}

model TravelPreferenceType {
  id              String                   @id @default(cuid())
  name            String                   @unique
  label           String
  description     String?
  icon            String?
  sortOrder       Int                      @default(0)
  isActive        Boolean                  @default(true)
  isRequired      Boolean                  @default(false)
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  options         TravelPreferenceOption[]
  userPreferences UserTravelPreference[]
}

model TravelPreferenceOption {
  id               String                 @id @default(cuid())
  preferenceTypeId String
  value            String
  label            String
  description      String?
  icon             String?
  sortOrder        Int                    @default(0)
  isActive         Boolean                @default(true)
  createdAt        DateTime               @default(now())
  preferenceType   TravelPreferenceType   @relation(fields: [preferenceTypeId], references: [id], onDelete: Cascade)
  userPreferences  UserTravelPreference[]

  @@unique([preferenceTypeId, value])
}

model UserTravelPreference {
  id               String                 @id @default(cuid())
  userId           String
  preferenceTypeId String
  optionId         String
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  option           TravelPreferenceOption @relation(fields: [optionId], references: [id])
  preferenceType   TravelPreferenceType   @relation(fields: [preferenceTypeId], references: [id])
  user             User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, preferenceTypeId])
}

model UserRelationship {
  id               String   @id @default(cuid())
  userId           String
  relatedUserId    String
  relationshipType String
  nickname         String?
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  relatedUser      User     @relation("RelatedToUser", fields: [relatedUserId], references: [id], onDelete: Cascade)
  user             User     @relation("UserRelationships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, relatedUserId])
}

model UserProfileGraph {
  id        String   @id @default(cuid())
  userId    String   @unique
  graphData String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ProfileCategory {
  id          String            @id @default(cuid())
  name        String
  slug        String            @unique
  description String?
  icon        String?
  color       String?
  parentId    String?
  level       Int               @default(0)
  sortOrder   Int               @default(0)
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  parent      ProfileCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    ProfileCategory[] @relation("CategoryHierarchy")
  values      ProfileValue[]

  @@index([parentId])
  @@index([level, sortOrder])
}

model ProfileValue {
  id          String             @id @default(cuid())
  value       String
  categoryId  String
  description String?
  icon        String?
  aliases     String[]
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  category    ProfileCategory    @relation(fields: [categoryId], references: [id])
  userValues  UserProfileValue[]

  @@unique([value, categoryId])
  @@index([categoryId])
}

model UserProfileValue {
  id        String       @id @default(cuid())
  userId    String
  valueId   String
  metadata  Json?
  notes     String?
  addedAt   DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  value     ProfileValue @relation(fields: [valueId], references: [id], onDelete: Cascade)

  @@unique([userId, valueId])
  @@index([userId])
  @@index([valueId])
}

model TravelExtractionQueue {
  id            String           @id @default(cuid())
  userId        String
  fileName      String
  fileType      String
  fileSize      Int
  fileUrl       String?
  textContent   String?
  status        ExtractionStatus @default(PENDING)
  progress      Int              @default(0)
  extractedData Json?
  errorMessage  String?
  tripId        String?
  createdAt     DateTime         @default(now())
  processedAt   DateTime?
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([createdAt])
}

enum TripStatus {
  DRAFT
  PLANNING
  LIVE
  ARCHIVED
}

enum TripPermission {
  PRIVATE
  FRIENDS
  LINK
  ANYONE
}

enum ChatType {
  TRIP
  SEGMENT
  RESERVATION
}

enum ExtractionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REVIEWED
}

model ExtractionFeedback {
  id              String   @id @default(cuid())
  
  // Email content
  emailText       String   @db.Text
  emailHash       String   @unique
  emailLength     Int
  
  // AI Detection
  aiTopType       String
  aiCategory      String
  aiConfidence    Float
  aiScore         Float
  aiScoring       Json
  
  // Alternative types
  aiAlternatives  Json
  
  // User Decision
  userSelectedType String
  userCategory     String
  wasOverridden    Boolean
  userReason       String?
  
  // Metadata
  userId          String?
  createdAt       DateTime @default(now())
  
  // Learning flags
  reviewed        Boolean  @default(false)
  incorporated    Boolean  @default(false)
  
  @@index([wasOverridden, reviewed])
  @@index([aiTopType, userSelectedType])
  @@index([createdAt])
}
